<!DOCTYPE html>
<html>
    <head>
        <title>NoC Visualization</title>
         <meta charset="utf-8"/>
    </head>
    <body>
        <script src='https://d3js.org/d3.v5.min.js'></script>
        <script src="https://d3js.org/d3-transition.v1.min.js"></script>

        <div id="chart_area">

        <button id="next_tick" onclick="on_click()">NEXT</button>

        <script>
            const width = 800;
            const height = 600;

            let svg = d3.select("#chart_area").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", "0 0 800 600")

            function on_click() {
                console.log("not ready... ");
            }

            d3.json("routers.json").then(function(data) {
                console.log(data);

                let maxrow = 0;
                let maxcol = 0;
                let maxrouted = 0;

                for (id of Object.keys(data)) {
                    let router = data[id];
                    if (router.row > maxrow) {maxrow = router.row;}
                    if (router.col > maxcol) {maxcol = router.col;}
                    if (router.totalrouted > maxrouted) {maxrouted = router.totalrouted}
                }

                console.log("maxrow", maxrow);
                console.log("maxcol", maxcol);
                console.log("maxrouted", maxrouted);

                const pitch = (height / maxrow) * 0.9;
                const diameter = pitch / 2;
                const radius = diameter / 2;
                let color = d3.scaleLinear()
                    .domain([0, maxrouted])
                    .range(["black", "red"]);

                // generate links
                for (id of Object.keys(data)) {
                    let router = data[id];
                    for (link of router.links) {
                        target = data[link];
                        svg.append("line")
                            .attr("style", "stroke: black")
                            .attr("x1", router.col * pitch + radius)
                            .attr("y1", router.row * pitch + radius)
                            .attr("x2", target.col * pitch + radius)
                            .attr("y2", target.row * pitch + radius);
                    }

                }

                // generate routers
                for (id of Object.keys(data)) {
                    let router = data[id];
                    svg.append("circle")
                        .attr("cx", router.col * pitch + radius)
                        .attr("cy", router.row * pitch + radius)
                        .attr("r", radius)
                        .attr("style", `fill: ${color(router.totalrouted)}`);
                }

                d3.json("packets.json").then(function(packets) {
                    var active = []
                    var tick = -1;

                    on_click = function () {
                        tick ++;

                        console.log(`tick=${tick}`);

                        var next_active = [];

                        if (packets[tick] != undefined) {
                            for (packet of packets[tick]) {
                                let router = data[packet.history[0]];
                                if (router == undefined) {continue;}
                                packet.circle = svg.append("circle")
                                    .attr("cx", router.col * pitch + radius)
                                    .attr("cy", router.row * pitch + radius)
                                    .attr("r", radius * 0.9)
                                    .attr("style", "fill: blue");
                                active.push(packet);
                                console.log(`created ${packet}`);
                            }
                        }

                        for (packet of active) {
                            // this packet is done
                            if (tick >= packet.history.length + packet.created) {
                                packet.circle.attr("visibility", "hidden");
                                console.log(`destroyed ${packet}`);
                            } else {
                                let router = data[packet.history[tick - packet.created]];
                                packet.circle.transition().duration(250)
                                    .attr("cx", router.col * pitch + radius)
                                    .attr("cy", router.row * pitch + radius);
                                next_active.push(packet);
                            }
                        }
                        active = next_active;
                    }

                });

            });

        </script>

    </body>
</html>
